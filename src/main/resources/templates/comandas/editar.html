<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" lang="pt-br" xmlns="http://www.w3.org/1999/xhtml"
      layout:decorate="~{layout}"
      xsi:schemaLocation="http://www.ultraq.net.nz/thymeleaf/layout
      http://www.thymeleaf.org/xsd/thymeleaf-extras-dialect-2.1.xsd">
<head>
  <meta charset="UTF-8">
</head>
<body>
  <nav layout:fragment="sidebar">
    <div id="mesa" class="list-group-item list-group-item-light small text-center py-1">Selecione a mesa</div>
    <div class="list-group-item list-group-item-primary">
      <div class="btn-group btn-block flex-md-wrap flex-xl-nowrap">
        <div class="btn-group w-100">
          <button type="button" class="btn btn-outline-primary dropdown-toggle btn-block" data-toggle="dropdown">Mesa
          </button>
          <div id="div-mesas" class="dropdown-menu">
            <section th:fragment="mesas">
              <button type="button" class="dropdown-item text-primary" onclick="buscaComandas(this.dataset.mesa)"
                      th:attr="data-mesa=${m}" th:each="m:${mesas}" th:text="${'Mesa '+m}">Mesa
              </button>
              <div class="dropdown-divider" th:if="!${mesas.isEmpty()}"></div>
              <a class="dropdown-item text-success" href="#" data-toggle="modal" data-target="#mdl-editar"><i
                  class="fas fa-plus"></i>&nbsp;Adicionar</a>
              <button type="button" class="dropdown-item text-secondary" onclick="atualizaMesas()"><i
                  class="fas fa-sync-alt"></i>&nbsp;Atualizar
              </button>
            </section>
          </div>
        </div>
        <div class="btn-group w-100">
          <button type="button" id="btn-comandas" class="btn btn-outline-primary dropdown-toggle btn-block"
                  th:classappend="${comandas==null}?'disabled':null" data-toggle="dropdown">Comanda
          </button>
          <div id="div-comandas" class="dropdown-menu">
            <section th:fragment="comandas" th:if="${comandas!=null}"
                     th:attr="data-comanda=${comandas.size()==1?comandas.entrySet().iterator().next().getKey():null}">
              <button type="button" class="dropdown-item text-primary" onclick="buscaComanda(this.dataset.codigo)"
                      th:each="c:${comandas.entrySet()}" th:attr="data-codigo=${c.getKey()}"
                      th:text="${c.getValue()==null?'Comanda '+c.getKey():c.getValue()}">Comanda
              </button>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item text-success" href="#" data-toggle="modal" data-target="#mdl-editar"
                 data-mesa="true"><i
                  class="fas fa-plus"></i>&nbsp;Adicionar</a>
              <button type="button" class="dropdown-item text-secondary" onclick="atualizaComandas()"><i
                  class="fas fa-sync-alt"></i>&nbsp;Atualizar
              </button>
            </section>
          </div>
        </div>
      </div>
    </div>
    <a class="list-group-item list-group-item-action text-center text-nowrap"
       th:href="@{/comandas/todas}"><i class="far fa-list-alt"></i>&nbsp;Ver todas</a>
  </nav>

  <h1 layout:fragment="title">Comandas</h1>

  <section id="div-alerts" layout:fragment="alerts" th:if="${comanda.codigo==null}">
    <div class="pb-1 alert alert-primary alert-dismissible">
      <h4 class="alert-heading">Informe a comanda</h4>
      <p>Utilize o menu para escolher ou adicionar mesa e comanda</p>
    </div>
  </section>

  <section layout:fragment="info">
    <div id="div-info" th:fragment="info" th:classappend="${comanda.codigo==null}?'d-none':null">
      <div class="mt-3 card border border-dark">
        <div class="card-header font-weight-bold d-flex justify-content-between align-items-center">
          <div class="align-middle">Comanda&nbsp;<span th:text="${comanda.codigo}"></span></div>
          <button class="btn btn-sm btn-outline-dark" onclick="buscaComanda(this.dataset.codigo)"
                  th:attr="data-codigo=${comanda.codigo}" title="Atualizar"><span class="fas fa-sync"></span></button>
        </div>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            Nome&nbsp;<span class="text-black-50" th:text="${comanda.nome}"></span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            Mesa&nbsp;<span class="text-black-50" th:text="${comanda.mesa}"></span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            Data&nbsp;<span class="text-black-50"
                            th:text="${#calendars.format(comanda.data,'dd/MM/yyyy HH:mm')}"></span>
          </li>
          <li class="list-group-item list-group-item-action list-group-item-secondary text-center pointer"
              data-toggle="modal" data-target="#mdl-editar"
              th:attr="data-nome=${comanda.nome},data-mesa=${comanda.mesa},data-codigo=${comanda.codigo}"><i
              class="fas fa-pencil-alt"></i>&nbsp;Editar
          </li>
          <li class="list-group-item list-group-item-action list-group-item-danger text-center pointer"
              data-toggle="modal" data-target="#mdl-finalizar" th:attr="data-codigo=${comanda.codigo}"><i
              class="fas fa-check"></i>&nbsp;Finalizar
          </li>
        </ul>
      </div>
    </div>
  </section>

  <section id="content" layout:fragment="content" th:classappend="${comanda.codigo==null}?'d-none':null">
    <div id="div-comanda" th:fragment="comanda">
      <!-- adicionar pedido -->
      <div class="bg-light rounded-top border border-success d-flex justify-content-between text-dark px-2 py-1">
        <div>Comanda&nbsp;<span id="comanda" th:text="${comanda.codigo}"></span></div>&nbsp;
        <div th:text="${comanda.getNome()}"></div>&nbsp;
        <div>Senha&nbsp;<span th:text="${comanda.senhaComanda()}"></span></div>
      </div>
      <form id="form-produto" onsubmit="return false" class="w-100 p-2 alert-success rounded-bottom mb-2">
        <input type="hidden" id="cod-prod" name="codigo">
        <div class="row">
          <div class="input-group col-md-7 col-lg-6 pb-lg-0 pb-1 flex-nowrap">
            <div class="input-group-prepend">
              <label class="input-group-text bg-light border-success" for="produto">Produto</label>
            </div>
            <input type="text" id="produto" class="form-control border-success" placeholder="Buscar..." required
                   onblur="blurProduto()">
          </div>
          <div class="input-group col-md-5 col-lg-4 pb-lg-0 pb-1 flex-nowrap">
            <div class="input-group-prepend">
              <label class="input-group-text bg-light border-success" for="quant">Quantidade</label>
            </div>
            <input id="quant" name="quantidade" class="form-control border-success" type="number" value="1" required>
          </div>
          <div class="col-lg-2 pb-lg-0 pb-1 flex-nowrap">
            <button type="submit" id="btn-addProd" class="btn btn-block btn-light border-success"
                    onclick="adicionaPedido()" disabled
            ><i id="fa-addProd" class="fas fa-plus"></i><span class="d-lg-none d-xl-inline-block">&nbsp;Adicionar</span>
            </button>
          </div>
        </div>
      </form>
      <!-- pedidos -->
      <div class="table-responsive">
        <table id="tbl-pedidos" class="table table-hover compact">
          <thead>
          <tr>
            <th>#</th>
            <th>Produto</th>
            <th>Quantidade</th>
            <th class="text-right">Situação</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="p:${comanda.getPedidos()}" th:attr="data-pedido=${p.codigo}">
            <td th:text="${p.codigo}"></td>
            <td>
              <p th:text="${p.produto.nome}"></p>
            </td>
            <td th:text="${p.quantidade}"></td>
            <td class="text-right">
              <div class="btn-group dropleft">
                <button class="btn btn-sm dropdown-toggle" type="button" data-toggle="dropdown" id="btn-status"
                        th:text="${p.status.desc}"
                        th:classappend="${p.status.name()=='C'}?'btn-outline-danger':(${p.status.name()=='E'}?'btn-outline-success':'btn-outline-dark')">
                </button>
                <div class="dropdown-menu py-1">
                  <button type="button" class="px-2 btn-sm dropdown-item" onclick="atualizaPedido(this)"
                          th:each="s:${statusPedido}" th:attr="data-status=${s}" th:text="${s.desc}"
                          th:classappend="${s.name()=='C'}?'text-danger':(${s.name()=='E'}?'text-success':null)"></button>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
  <section layout:fragment="modals">
    <div id="mdl-editar" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Nova comanda</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span class="fas fa-times"></span>
            </button>
          </div>
          <div class="modal-body">
            <form id="form-editar" onsubmit="return salvaComanda()">
              <input id="editar-codigo" type="hidden" name="codigo" value="null">
              <!-- nome -->
              <div class="input-group">
                <div class="input-group-prepend">
                  <label class="input-group-text" for="editar-nome">Nome</label>
                </div>
                <input id="editar-nome" class="form-control" title="Nome do cliente" type="text" name="nome">
              </div>
              <div class="d-flex justify-content-end">
                <label for="editar-nome" class="small text-muted">Opcional</label>
              </div>
              <!-- mesa -->
              <div class="input-group">
                <div class="input-group-prepend">
                  <label class="input-group-text" for="editar-mesa">Mesa</label>
                </div>
                <input id="editar-mesa" class="form-control" type="number" name="mesa" title="Número da mesa"
                       required>
              </div>
              <!-- atendente -->
              <div class="input-group pt-2">
                <div class="input-group-prepend">
                  <label class="input-group-text" for="editar-atendente">Atendente</label>
                </div>
                <input id="editar-atendente" class="form-control" type="text" th:value="${#authentication.name}"
                       readonly>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
            <button type="submit" form="form-editar" class="btn btn-success">Salvar</button>
          </div>
        </div>
      </div>
    </div>
    <div id="mdl-finalizar" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Finalizar comanda</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span class="fas fa-times"></span>
            </button>
          </div>
          <div class="modal-body">
            <p>Para reabrir a comanda, utilize a opção <a th:href="@{/comandas/todas}" class="active">Ver todas</a>.</p>
            <form id="form-finalizar" onsubmit="return finalizaComanda()">
              <input id="finalizar-codigo" type="hidden" name="codigo" value="null">
              <!-- status -->
              <div class="input-group">
                <div class="input-group-prepend">
                  <label class="input-group-text" for="finalizar-status">Situação</label>
                </div>
                <select id="finalizar-status" class="custom-select" title="Situação da comanda" name="status" required>
                  <option th:each="s:${statusComanda}" th:value="${s}" th:selected="${s.name()=='A'}"
                          th:disabled="${s.name()=='A'}" th:text="${s.desc}"></option>
                </select>
              </div>
              <div class="d-flex justify-content-end">
                <label for="finalizar-status" class="small text-muted">Só é possível alterar comandas abertas</label>
              </div>
            </form>
            <p class="small">Importante: Cancelar a comanda <b>não</b> devolve os produtos ao estoque. Se necessário,
              cancele os pedidos antes de continuar.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
            <button type="submit" form="form-finalizar" class="btn btn-danger">Salvar</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</body>
<script src="/static/js/utilities.js"></script>
<script src="/static/js/comandas.js"></script>
<section layout:fragment="scripts">
  <script th:src="@{/js/comandas.min.js}"></script>
</section>
</html>